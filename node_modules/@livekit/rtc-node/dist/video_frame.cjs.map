{"version":3,"sources":["../src/video_frame.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2024 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport { create } from '@bufbuild/protobuf';\nimport { FfiClient } from './ffi_client.js';\nimport { FfiRequestSchema } from './proto/ffi_pb.js';\nimport type {\n  OwnedVideoBuffer,\n  VideoBufferInfo,\n  VideoBufferInfo_ComponentInfo,\n  VideoConvertResponse,\n} from './proto/video_frame_pb.js';\nimport {\n  VideoBufferInfoSchema,\n  VideoBufferInfo_ComponentInfoSchema,\n  VideoBufferType,\n} from './proto/video_frame_pb.js';\n\nexport class VideoFrame {\n  data: Uint8Array;\n  width: number;\n  height: number;\n  type: VideoBufferType;\n\n  constructor(data: Uint8Array, width: number, height: number, type: VideoBufferType) {\n    this.data = data;\n    this.width = width;\n    this.height = height;\n    this.type = type;\n  }\n\n  /** @internal */\n  get dataPtr(): bigint {\n    return FfiClient.instance.retrievePtr(new Uint8Array(this.data.buffer));\n  }\n\n  /** @internal */\n  protoInfo(): VideoBufferInfo {\n    const info = create(VideoBufferInfoSchema, {\n      width: this.width,\n      height: this.height,\n      type: this.type,\n      dataPtr: this.dataPtr,\n    });\n\n    switch (this.type) {\n      case VideoBufferType.ARGB:\n      case VideoBufferType.RGBA:\n      case VideoBufferType.ABGR:\n      case VideoBufferType.BGRA:\n        info.stride = this.width * 4;\n        break;\n      case VideoBufferType.RGB24:\n        info.stride = this.width * 3;\n        break;\n    }\n\n    info.components.push(...getPlaneInfos(this.dataPtr, this.type, this.width, this.height));\n\n    return info;\n  }\n\n  /** @internal */\n  static fromOwnedInfo(owned: OwnedVideoBuffer): VideoFrame {\n    const info = owned.info!;\n    return new VideoFrame(\n      FfiClient.instance.copyBuffer(\n        info.dataPtr,\n        getPlaneLength(info.type, info.width, info.height),\n      ),\n      info.width,\n      info.height,\n      info.type,\n    );\n  }\n\n  getPlane(planeNth: number): Uint8Array | void {\n    const planeInfos = getPlaneInfos(this.dataPtr, this.type, this.width, this.height);\n    if (planeNth >= planeInfos.length) return;\n\n    const planeInfo = planeInfos[planeNth]!;\n    return FfiClient.instance.copyBuffer(planeInfo.dataPtr, planeInfo.size);\n  }\n\n  convert(dstType: VideoBufferType, flipY = false): VideoFrame {\n    const req = create(FfiRequestSchema, {\n      message: {\n        case: 'videoConvert',\n        value: {\n          flipY,\n          dstType,\n          buffer: this.protoInfo(),\n        },\n      },\n    });\n    const resp = FfiClient.instance.request<VideoConvertResponse>(req);\n    if (resp.message.case !== 'buffer') {\n      throw new Error(resp.message.value ?? 'Unknown Error');\n    }\n\n    return VideoFrame.fromOwnedInfo(resp.message.value);\n  }\n}\n\nconst getPlaneLength = (type: VideoBufferType, width: number, height: number): number => {\n  const chromaWidth = Math.trunc((width + 1) / 2);\n  const chromaHeight = Math.trunc((height + 1) / 2);\n  switch (type) {\n    case VideoBufferType.ARGB:\n    case VideoBufferType.RGBA:\n    case VideoBufferType.ABGR:\n    case VideoBufferType.BGRA:\n      return width * height * 4;\n    case VideoBufferType.RGB24:\n    case VideoBufferType.I444:\n      return width * height * 3;\n    case VideoBufferType.I420:\n      return width * height + chromaWidth * chromaHeight * 2;\n    case VideoBufferType.I420A:\n      return width * height * 2 + chromaWidth * chromaWidth * 2;\n    case VideoBufferType.I422:\n      return width * height + chromaWidth * height * 2;\n    case VideoBufferType.I010:\n      return width * height * 2 + chromaWidth * chromaHeight * 4;\n    case VideoBufferType.NV12:\n      return width * height + chromaWidth * chromaWidth * 2;\n  }\n};\n\nconst getPlaneInfos = (\n  dataPtr: bigint,\n  type: VideoBufferType,\n  width: number,\n  height: number,\n): VideoBufferInfo_ComponentInfo[] => {\n  const chromaWidth = Math.trunc((width + 1) / 2);\n  const chromaHeight = Math.trunc((height + 1) / 2);\n  switch (type) {\n    case VideoBufferType.I420: {\n      const y = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr,\n        stride: width,\n        size: width * height,\n      });\n      const u = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: y.dataPtr + BigInt(y.size),\n        stride: chromaWidth,\n        size: chromaWidth * chromaHeight,\n      });\n      const v = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: u.dataPtr + BigInt(u.size),\n        stride: chromaWidth,\n        size: chromaWidth * chromaHeight,\n      });\n      return [y, u, v];\n    }\n    case VideoBufferType.I420A: {\n      const y = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr,\n        stride: width,\n        size: width * height,\n      });\n      const u = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: y.dataPtr + BigInt(y.size),\n        stride: chromaWidth,\n        size: chromaWidth * chromaHeight,\n      });\n      const v = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: u.dataPtr + BigInt(u.size),\n        stride: chromaWidth,\n        size: chromaWidth * chromaHeight,\n      });\n      const a = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: v.dataPtr + BigInt(v.size),\n        stride: width,\n        size: width * height,\n      });\n      return [y, u, v, a];\n    }\n    case VideoBufferType.I422: {\n      const y = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr,\n        stride: width,\n        size: width * height,\n      });\n      const u = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: y.dataPtr + BigInt(y.size),\n        stride: chromaWidth,\n        size: chromaWidth * height,\n      });\n      const v = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: u.dataPtr + BigInt(u.size),\n        stride: chromaWidth,\n        size: chromaWidth * height,\n      });\n      return [y, u, v];\n    }\n    case VideoBufferType.I444: {\n      const y = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr,\n        stride: width,\n        size: width * height,\n      });\n      const u = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: y.dataPtr + BigInt(y.size),\n        stride: width,\n        size: width * height,\n      });\n      const v = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: u.dataPtr + BigInt(u.size),\n        stride: width,\n        size: width * height,\n      });\n      return [y, u, v];\n    }\n    case VideoBufferType.I010: {\n      const y = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr,\n        stride: width * 2,\n        size: width * height * 2,\n      });\n      const u = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: y.dataPtr + BigInt(y.size),\n        stride: chromaWidth * 2,\n        size: chromaWidth * chromaHeight * 2,\n      });\n      const v = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: u.dataPtr + BigInt(u.size),\n        stride: chromaWidth * 2,\n        size: chromaWidth * chromaHeight * 2,\n      });\n      return [y, u, v];\n    }\n    case VideoBufferType.NV12: {\n      const y = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr,\n        stride: width,\n        size: width * height,\n      });\n      const uv = create(VideoBufferInfo_ComponentInfoSchema, {\n        dataPtr: y.dataPtr + BigInt(y.size),\n        stride: chromaWidth * 2,\n        size: chromaWidth * chromaHeight * 2,\n      });\n      return [y, uv];\n    }\n    default:\n      return [];\n  }\n};\n"],"mappings":"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","names":[]}