{"version":3,"sources":["../src/room.ts"],"sourcesContent":["// SPDX-FileCopyrightText: 2024 LiveKit, Inc.\n//\n// SPDX-License-Identifier: Apache-2.0\nimport { create } from '@bufbuild/protobuf';\nimport type { TypedEventEmitter as TypedEmitter } from '@livekit/typed-emitter';\nimport EventEmitter from 'events';\nimport type { E2EEOptions } from './e2ee.js';\nimport { E2EEManager } from './e2ee.js';\nimport { FfiClient, FfiClientEvent, FfiHandle } from './ffi_client.js';\nimport type { Participant } from './participant.js';\nimport { LocalParticipant, RemoteParticipant } from './participant.js';\nimport { EncryptionState } from './proto/e2ee_pb.js';\nimport type { FfiEvent } from './proto/ffi_pb.js';\nimport type { OwnedParticipant } from './proto/participant_pb.js';\nimport type {\n  ConnectCallback,\n  ConnectResponse,\n  ConnectionQuality,\n  DataPacketKind,\n  DisconnectReason,\n  DisconnectResponse,\n  RoomOptions as FfiRoomOptions,\n  IceServer,\n  RoomInfo,\n} from './proto/room_pb.js';\nimport {\n  ConnectRequestSchema,\n  ConnectionState,\n  ContinualGatheringPolicy,\n  IceTransportType,\n} from './proto/room_pb.js';\nimport { TrackKind } from './proto/track_pb.js';\nimport type { LocalTrack, RemoteTrack } from './track.js';\nimport { RemoteAudioTrack, RemoteVideoTrack } from './track.js';\nimport type { LocalTrackPublication, TrackPublication } from './track_publication.js';\nimport { RemoteTrackPublication } from './track_publication.js';\nimport type { ChatMessage } from './types.js';\n\nexport interface RtcConfiguration {\n  iceTransportType: IceTransportType;\n  continualGatheringPolicy: ContinualGatheringPolicy;\n  iceServers: IceServer[];\n}\n\nexport const defaultRtcConfiguration: RtcConfiguration = {\n  iceTransportType: IceTransportType.TRANSPORT_ALL,\n  continualGatheringPolicy: ContinualGatheringPolicy.GATHER_CONTINUALLY,\n  iceServers: [],\n};\n\nexport interface RoomOptions {\n  autoSubscribe: boolean;\n  dynacast: boolean;\n  e2ee?: E2EEOptions;\n  rtcConfig?: RtcConfiguration;\n}\n\nexport const defaultRoomOptions = {\n  autoSubscribe: true,\n  dynacast: false,\n  e2ee: undefined,\n  rtcConfig: undefined,\n  adaptiveStream: false,\n  joinRetries: 1,\n} satisfies Omit<FfiRoomOptions, '$typeName'>;\n\nexport class Room extends (EventEmitter as new () => TypedEmitter<RoomCallbacks>) {\n  private info?: RoomInfo;\n  private ffiHandle?: FfiHandle;\n\n  e2eeManager?: E2EEManager;\n  connectionState: ConnectionState = ConnectionState.CONN_DISCONNECTED;\n\n  remoteParticipants: Map<string, RemoteParticipant> = new Map();\n  localParticipant?: LocalParticipant;\n\n  constructor() {\n    super();\n  }\n\n  get name(): string | undefined {\n    return this.info?.name;\n  }\n\n  get metadata(): string | undefined {\n    return this.info?.metadata;\n  }\n\n  get isConnected(): boolean {\n    return this.ffiHandle != undefined && this.connectionState != ConnectionState.CONN_DISCONNECTED;\n  }\n\n  async getSid(): Promise<string> {\n    if (!this.isConnected) {\n      return '';\n    }\n    if (this.info && this.info.sid !== '') {\n      return this.info.sid;\n    }\n    return new Promise((resolve, reject) => {\n      const handleRoomUpdate = (sid: string) => {\n        if (sid !== '') {\n          this.off(RoomEvent.RoomSidChanged, handleRoomUpdate);\n          resolve(sid);\n        }\n      };\n      this.on(RoomEvent.RoomSidChanged, handleRoomUpdate);\n      this.once(RoomEvent.Disconnected, () => {\n        this.off(RoomEvent.RoomSidChanged, handleRoomUpdate);\n        reject('Room disconnected before room server id was available');\n      });\n    });\n  }\n\n  async connect(url: string, token: string, opts?: RoomOptions) {\n    const options = { ...defaultRoomOptions, ...opts };\n\n    const req = create(ConnectRequestSchema, {\n      url: url,\n      token: token,\n      options,\n    });\n\n    const res = FfiClient.instance.request<ConnectResponse>({\n      message: {\n        case: 'connect',\n        value: req,\n      },\n    });\n\n    const cb = await FfiClient.instance.waitFor<ConnectCallback>((ev: FfiEvent) => {\n      return ev.message.case == 'connect' && ev.message.value.asyncId == res.asyncId;\n    });\n\n    if (cb.message.case !== 'result') {\n      throw new ConnectError(cb.message.value ?? 'Unknown error');\n    }\n\n    const { room, localParticipant, participants } = cb.message.value;\n\n    this.ffiHandle = new FfiHandle(room!.handle!.id);\n    if (options.e2ee) {\n      this.e2eeManager = new E2EEManager(this.ffiHandle.handle, options.e2ee);\n    }\n\n    this.info = room!.info;\n    this.connectionState = ConnectionState.CONN_CONNECTED;\n    this.localParticipant = new LocalParticipant(localParticipant!);\n\n    for (const pt of participants) {\n      const rp = this.createRemoteParticipant(pt.participant!);\n\n      for (const pub of pt.publications) {\n        const publication = new RemoteTrackPublication(pub);\n        rp.trackPublications.set(publication.sid, publication);\n      }\n    }\n\n    FfiClient.instance.on(FfiClientEvent.FfiEvent, this.onFfiEvent);\n  }\n\n  async disconnect() {\n    if (!this.isConnected || !this.ffiHandle) {\n      return;\n    }\n\n    FfiClient.instance.request<DisconnectResponse>({\n      message: {\n        case: 'disconnect',\n        value: {\n          roomHandle: this.ffiHandle.handle,\n        },\n      },\n    });\n\n    FfiClient.instance.removeListener(FfiClientEvent.FfiEvent, this.onFfiEvent);\n    this.removeAllListeners();\n  }\n\n  private onFfiEvent = (ffiEvent: FfiEvent) => {\n    if (!this.localParticipant || !this.ffiHandle || !this.info) {\n      throw TypeError('cannot handle ffi events before connectCallback');\n    }\n\n    if (ffiEvent.message.case == 'rpcMethodInvocation') {\n      if (\n        ffiEvent.message.value.localParticipantHandle == this.localParticipant.ffi_handle.handle\n      ) {\n        this.localParticipant.handleRpcMethodInvocation(\n          ffiEvent.message.value.invocationId,\n          ffiEvent.message.value.method,\n          ffiEvent.message.value.requestId,\n          ffiEvent.message.value.callerIdentity,\n          ffiEvent.message.value.payload,\n          ffiEvent.message.value.responseTimeoutMs,\n        );\n      }\n      return;\n    } else if (\n      ffiEvent.message.case != 'roomEvent' ||\n      ffiEvent.message.value.roomHandle != this.ffiHandle.handle\n    ) {\n      return;\n    }\n\n    const ev = ffiEvent.message.value.message;\n    if (ev.case == 'participantConnected') {\n      const participant = this.createRemoteParticipant(ev.value.info!);\n      this.remoteParticipants.set(participant.identity, participant);\n      this.emit(RoomEvent.ParticipantConnected, participant);\n    } else if (ev.case == 'participantDisconnected') {\n      const participant = this.remoteParticipants.get(ev.value.participantIdentity);\n      if (participant) {\n        this.remoteParticipants.delete(participant.identity);\n        this.emit(RoomEvent.ParticipantDisconnected, participant);\n      }\n    } else if (ev.case == 'localTrackPublished') {\n      const publication = this.localParticipant.trackPublications.get(ev.value.trackSid);\n      if (!publication) {\n        throw new TypeError('local track publication not found');\n      }\n      this.emit(RoomEvent.LocalTrackPublished, publication, this.localParticipant);\n    } else if (ev.case == 'localTrackUnpublished') {\n      const publication = this.localParticipant.trackPublications.get(ev.value.publicationSid);\n      this.localParticipant.trackPublications.delete(ev.value.publicationSid);\n      if (publication) {\n        this.emit(RoomEvent.LocalTrackUnpublished, publication, this.localParticipant);\n      }\n    } else if (ev.case == 'localTrackSubscribed') {\n      const publication = this.localParticipant.trackPublications.get(ev.value.trackSid);\n      if (!publication) {\n        throw new TypeError('local track publication not found');\n      }\n      publication.resolveFirstSubscription();\n      this.emit(RoomEvent.LocalTrackSubscribed, publication.track!);\n    } else if (ev.case == 'trackPublished') {\n      const participant = this.requireRemoteParticipant(ev.value.participantIdentity);\n      const publication = new RemoteTrackPublication(ev.value.publication!);\n      participant.trackPublications.set(publication.sid, publication);\n      this.emit(RoomEvent.TrackPublished, publication, participant);\n    } else if (ev.case == 'trackUnpublished') {\n      const participant = this.requireRemoteParticipant(ev.value.participantIdentity);\n      const publication = participant.trackPublications.get(ev.value.publicationSid);\n      participant.trackPublications.delete(ev.value.publicationSid);\n      if (publication) {\n        this.emit(RoomEvent.TrackUnpublished, publication, participant);\n      }\n    } else if (ev.case == 'trackSubscribed') {\n      const ownedTrack = ev.value.track!;\n      const trackInfo = ownedTrack.info!;\n      const { participant, publication } = this.requirePublicationOfRemoteParticipant(\n        ev.value.participantIdentity,\n        trackInfo.sid,\n      );\n      publication.subscribed = true;\n      if (trackInfo.kind == TrackKind.KIND_VIDEO) {\n        publication.track = new RemoteVideoTrack(ownedTrack);\n      } else if (trackInfo.kind == TrackKind.KIND_AUDIO) {\n        publication.track = new RemoteAudioTrack(ownedTrack);\n      }\n\n      this.emit(RoomEvent.TrackSubscribed, publication.track!, publication, participant);\n    } else if (ev.case == 'trackUnsubscribed') {\n      const { participant, publication } = this.requirePublicationOfRemoteParticipant(\n        ev.value.participantIdentity,\n        ev.value.trackSid,\n      );\n      const track = publication.track!;\n      publication.track = undefined;\n      publication.subscribed = false;\n      this.emit(RoomEvent.TrackUnsubscribed, track, publication, participant);\n    } else if (ev.case == 'trackSubscriptionFailed') {\n      const participant = this.requireRemoteParticipant(ev.value.participantIdentity);\n      this.emit(RoomEvent.TrackSubscriptionFailed, ev.value.trackSid, participant, ev.value.error);\n    } else if (ev.case == 'trackMuted') {\n      const { participant, publication } = this.requirePublicationOfParticipant(\n        ev.value.participantIdentity,\n        ev.value.trackSid,\n      );\n      publication.info.muted = true;\n      if (publication.track) {\n        publication.track.info.muted = true;\n      }\n      this.emit(RoomEvent.TrackMuted, publication, participant);\n    } else if (ev.case == 'trackUnmuted') {\n      const { participant, publication } = this.requirePublicationOfParticipant(\n        ev.value.participantIdentity,\n        ev.value.trackSid,\n      );\n      publication.info.muted = false;\n      if (publication.track) {\n        publication.track.info.muted = false;\n      }\n      this.emit(RoomEvent.TrackUnmuted, publication, participant);\n    } else if (ev.case == 'activeSpeakersChanged') {\n      const activeSpeakers = ev.value.participantIdentities.map((identity) =>\n        this.requireParticipantByIdentity(identity),\n      );\n      this.emit(RoomEvent.ActiveSpeakersChanged, activeSpeakers);\n    } else if (ev.case == 'roomMetadataChanged') {\n      this.info.metadata = ev.value.metadata;\n      this.emit(RoomEvent.RoomMetadataChanged, this.info.metadata);\n    } else if (ev.case == 'participantMetadataChanged') {\n      const participant = this.requireParticipantByIdentity(ev.value.participantIdentity);\n      participant.info.metadata = ev.value.metadata;\n      this.emit(RoomEvent.ParticipantMetadataChanged, participant.metadata, participant);\n    } else if (ev.case == 'participantNameChanged') {\n      const participant = this.requireParticipantByIdentity(ev.value.participantIdentity);\n      participant.info.name = ev.value.name;\n      this.emit(RoomEvent.ParticipantNameChanged, participant.name, participant);\n    } else if (ev.case == 'participantAttributesChanged') {\n      const participant = this.requireParticipantByIdentity(ev.value.participantIdentity);\n      participant.info.attributes = ev.value.attributes.reduce(\n        (acc, value) => {\n          acc[value.key] = value.value;\n          return acc;\n        },\n        {} as Record<string, string>,\n      );\n      if (Object.keys(ev.value.changedAttributes).length > 0) {\n        const changedAttributes = ev.value.changedAttributes.reduce(\n          (acc, value) => {\n            acc[value.key] = value.value;\n            return acc;\n          },\n          {} as Record<string, string>,\n        );\n        this.emit(RoomEvent.ParticipantAttributesChanged, changedAttributes, participant);\n      }\n    } else if (ev.case == 'connectionQualityChanged') {\n      const participant = this.requireParticipantByIdentity(ev.value.participantIdentity);\n      this.emit(RoomEvent.ConnectionQualityChanged, ev.value.quality, participant);\n    } else if (ev.case == 'chatMessage') {\n      const participant = this.retrieveParticipantByIdentity(ev.value.participantIdentity);\n      const { id, message: messageText, timestamp, editTimestamp, generated } = ev.value.message!;\n      const message: ChatMessage = {\n        id,\n        message: messageText,\n        timestamp: Number(timestamp),\n        editTimestamp: Number(editTimestamp),\n        generated,\n      };\n      this.emit(RoomEvent.ChatMessage, message, participant);\n    } else if (ev.case == 'dataPacketReceived') {\n      // Can be undefined if the data is sent from a Server SDK\n      const participant = this.remoteParticipants.get(ev.value.participantIdentity);\n      const dataPacket = ev.value.value;\n      switch (dataPacket.case) {\n        case 'user':\n          const data = dataPacket.value.data!.data!;\n          const buffer = FfiClient.instance.copyBuffer(data.dataPtr, Number(data.dataLen));\n          new FfiHandle(dataPacket.value.data!.handle!.id).dispose();\n          this.emit(\n            RoomEvent.DataReceived,\n            buffer,\n            participant,\n            ev.value.kind,\n            dataPacket.value.topic,\n          );\n          break;\n        case 'sipDtmf':\n          const { code, digit } = dataPacket.value;\n          this.emit(RoomEvent.DtmfReceived, code, digit, participant);\n          break;\n        default:\n          break;\n      }\n    } else if (ev.case == 'e2eeStateChanged') {\n      if (ev.value.state == EncryptionState.INTERNAL_ERROR) {\n        // throw generic error until Rust SDK is updated to supply the error alongside INTERNAL_ERROR\n        this.emit(RoomEvent.EncryptionError, new Error('internal server error'));\n      }\n    } else if (ev.case == 'connectionStateChanged') {\n      this.connectionState = ev.value.state;\n      this.emit(RoomEvent.ConnectionStateChanged, this.connectionState);\n      /*} else if (ev.case == 'connected') {\n      this.emit(RoomEvent.Connected);*/\n    } else if (ev.case == 'disconnected') {\n      this.emit(RoomEvent.Disconnected, ev.value.reason);\n    } else if (ev.case == 'reconnecting') {\n      this.emit(RoomEvent.Reconnecting);\n    } else if (ev.case == 'reconnected') {\n      this.emit(RoomEvent.Reconnected);\n    } else if (ev.case == 'roomSidChanged') {\n      this.emit(RoomEvent.RoomSidChanged, ev.value.sid);\n    }\n  };\n\n  private retrieveParticipantByIdentity(identity: string): Participant | undefined {\n    if (this.localParticipant?.identity === identity) {\n      return this.localParticipant;\n    } else {\n      return this.remoteParticipants.get(identity);\n    }\n  }\n\n  private requireParticipantByIdentity(identity: string): Participant {\n    if (this.localParticipant?.identity === identity) {\n      return this.localParticipant;\n    } else if (this.remoteParticipants.has(identity)) {\n      return this.remoteParticipants.get(identity)!;\n    } else {\n      throw new TypeError(`participant ${identity} not found`);\n    }\n  }\n\n  private requireRemoteParticipant(identity: string) {\n    const participant = this.remoteParticipants.get(identity);\n    if (!participant) {\n      throw new TypeError(`participant ${identity} not found`);\n    }\n    return participant;\n  }\n\n  private requirePublicationOfParticipant(identity: string, trackSid: string) {\n    const participant = this.requireParticipantByIdentity(identity);\n    const publication = participant.trackPublications.get(trackSid);\n    if (!publication) {\n      throw new TypeError(`publication ${trackSid} not found`);\n    }\n    return { participant, publication };\n  }\n\n  private requirePublicationOfRemoteParticipant(identity: string, trackSid: string) {\n    const participant = this.requireRemoteParticipant(identity);\n    const publication = participant.trackPublications.get(trackSid);\n    if (!publication) {\n      throw new TypeError(`publication ${trackSid} not found`);\n    }\n    return { participant, publication };\n  }\n\n  private createRemoteParticipant(ownedInfo: OwnedParticipant) {\n    if (this.remoteParticipants.has(ownedInfo.info!.identity)) {\n      throw new Error('Participant already exists');\n    }\n\n    const participant = new RemoteParticipant(ownedInfo);\n    this.remoteParticipants.set(ownedInfo.info!.identity, participant);\n    return participant;\n  }\n}\n\nexport class ConnectError extends Error {\n  constructor(message: string) {\n    super(message);\n  }\n}\n\nexport type RoomCallbacks = {\n  participantConnected: (participant: RemoteParticipant) => void;\n  participantDisconnected: (participant: RemoteParticipant) => void;\n  localTrackPublished: (publication: LocalTrackPublication, participant: LocalParticipant) => void;\n  localTrackUnpublished: (\n    publication: LocalTrackPublication,\n    participant: LocalParticipant,\n  ) => void;\n  localTrackSubscribed: (track: LocalTrack) => void;\n  trackPublished: (publication: RemoteTrackPublication, participant: RemoteParticipant) => void;\n  trackUnpublished: (publication: RemoteTrackPublication, participant: RemoteParticipant) => void;\n  trackSubscribed: (\n    track: RemoteTrack,\n    publication: RemoteTrackPublication,\n    participant: RemoteParticipant,\n  ) => void;\n  trackUnsubscribed: (\n    track: RemoteTrack,\n    publication: RemoteTrackPublication,\n    participant: RemoteParticipant,\n  ) => void;\n  trackSubscriptionFailed: (\n    trackSid: string,\n    participant: RemoteParticipant,\n    reason?: string,\n  ) => void;\n  trackMuted: (publication: TrackPublication, participant: Participant) => void;\n  trackUnmuted: (publication: TrackPublication, participant: Participant) => void;\n  activeSpeakersChanged: (speakers: Participant[]) => void;\n  roomMetadataChanged: (metadata: string) => void;\n  roomInfoUpdated: (info: RoomInfo) => void;\n  participantMetadataChanged: (metadata: string | undefined, participant: Participant) => void;\n  participantNameChanged: (name: string, participant: Participant) => void;\n  participantAttributesChanged: (\n    changedAttributes: Record<string, string>,\n    participant: Participant,\n  ) => void;\n  connectionQualityChanged: (quality: ConnectionQuality, participant: Participant) => void;\n  dataReceived: (\n    payload: Uint8Array,\n    participant?: RemoteParticipant,\n    kind?: DataPacketKind,\n    topic?: string,\n  ) => void;\n  chatMessage: (message: ChatMessage, participant?: Participant) => void;\n  dtmfReceived: (code: number, digit: string, participant?: RemoteParticipant) => void;\n  encryptionError: (error: Error) => void;\n  connectionStateChanged: (state: ConnectionState) => void;\n  connected: () => void;\n  disconnected: (reason: DisconnectReason) => void;\n  reconnecting: () => void;\n  reconnected: () => void;\n  roomSidChanged: (sid: string) => void;\n};\n\nexport enum RoomEvent {\n  ParticipantConnected = 'participantConnected',\n  ParticipantDisconnected = 'participantDisconnected',\n  LocalTrackPublished = 'localTrackPublished',\n  LocalTrackUnpublished = 'localTrackUnpublished',\n  LocalTrackSubscribed = 'localTrackSubscribed',\n  TrackPublished = 'trackPublished',\n  TrackUnpublished = 'trackUnpublished',\n  TrackSubscribed = 'trackSubscribed',\n  TrackUnsubscribed = 'trackUnsubscribed',\n  TrackSubscriptionFailed = 'trackSubscriptionFailed',\n  TrackMuted = 'trackMuted',\n  TrackUnmuted = 'trackUnmuted',\n  ActiveSpeakersChanged = 'activeSpeakersChanged',\n  RoomMetadataChanged = 'roomMetadataChanged',\n  RoomSidChanged = 'roomSidChanged',\n  ParticipantMetadataChanged = 'participantMetadataChanged',\n  ParticipantNameChanged = 'participantNameChanged',\n  ParticipantAttributesChanged = 'participantAttributesChanged',\n  ConnectionQualityChanged = 'connectionQualityChanged',\n  DataReceived = 'dataReceived',\n  ChatMessage = 'chatMessage',\n  DtmfReceived = 'dtmfReceived',\n  EncryptionError = 'encryptionError',\n  ConnectionStateChanged = 'connectionStateChanged',\n  Connected = 'connected',\n  Disconnected = 'disconnected',\n  Reconnecting = 'reconnecting',\n  Reconnected = 'reconnected',\n}\n"],"mappings":"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","names":["EventEmitter","RoomEvent"]}